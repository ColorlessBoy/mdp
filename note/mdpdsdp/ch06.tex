% Chapter06 Discounted Markov Decision Problems, Markov Decision Processes Discrete Stochastic Dynamic Programming.

\section{Discounted Markov Decision Problems}%
\label{sec:discounted_markov_decision_problems}

Assumptions in this chapter:
\begin{enumerate}
    \item Stationary rewards and transition probabilities; $ r(s, a) $ and $ p(s' | s, a) $ do not vary from decision epoch to decision epoch.
    \item Bounded rewards; $ \left| r(s, a) \right| \le M < \infty $.
    \item Discount factor $ \lambda $.
    \item Discrete state spaces.
\end{enumerate}

\subsection{POLECY EVALUATION (Stationary Policy)}%
\label{sub:polecy_evaluation}

\[
    v^*_\lambda(s) = \sup_{\pi \in \Pi^{HR}} v^\pi_\lambda(s) = \sup_{\pi \in \Pi^{MR}} v^\pi_\lambda(s)
\]
Let $ \pi = (d_1, d_2, \ldots) \in \Pi^{MR} $,then 
\[
    v^\pi_\lambda(s_1) = \mathbb{E}^\pi_{s_1} \left\{ \sum^{\infty}_{t=1} \lambda^{t-1} r(X_t, Y_t) \right\}
    = r_{d_1} + \lambda P_{d_1} v^{\pi' = \left\{ d_2, d_3, \ldots \right\}}_\lambda
\]
Let $ d^\infty = (d, d, \ldots) $, then $ v^{d^\infty}_\lambda(s_1) = r_d(s_1) + \lambda P_d v^{d^\infty}_\lambda $. \\
Let $ \forall v \in V, L_d v = r_d + \lambda P_d v $, then $ v^{d^\infty}_\lambda = L_d v^{d^\infty}_\lambda $, which means $ v^{d^\infty}_\lambda $ is a fixed point of $ L_d $ in V.

\begin{theorem}
Suppose $ 0 \le \lambda < 1 $. Then $ \forall d^\infty $ with $ d \in D^{MR} $, $ \vec v^{d^\infty}_\lambda $ is the unique solution in V of $ \vec v = r_d + \lambda P_d \vec v $, and $ \vec v^{d^\infty}_\lambda = {(I - \lambda P_d)}^{-1} r_d $.
    \begin{proof}
        Key theorem:
    $ \Arrowvert P_d \Arrowvert = 1 $ and $ \sigma (\lambda P_d) \le \Arrowvert \lambda P_d \Arrowvert = \lambda \le 1$, then $ {(I - \lambda P_d)}^{-1} $ exists.
        \[
            \vec v = {(I - \lambda P_d)}^{-1} r_d = \sum^{\infty}_{t=1} \lambda^{t-1} P^{t-1}_d r_d = \vec v^{d^\infty}_\lambda
        \]
    \end{proof}
\end{theorem}

\begin{lemma}
    \begin{enumerate}
        \item $ \vec u \succeq \vec 0 \Rightarrow {(I - \lambda P_d)}^{-1} \vec u \succeq \vec u \succeq \vec 0 $
        \item $ \vec u \succeq \vec v \Rightarrow {(I - \lambda P_d)}^{-1} \vec u \succeq {(I - \lambda P_d)}^{-1} \vec v $
        \item $ \vec u \succeq \vec 0 \Rightarrow \vec u^T {(I - \lambda P_d)}^{-1} \succeq \vec u^T $
    \end{enumerate}
\end{lemma}

\subsection{OPTIMALITY EQUATIONS}%
\label{sub:optimality_equations}

Optimality equations or Bellamn equations (in discounted MDP):
\[
    v(s) = \sup_{a \in A_s} \left\{ r(s, a) + \sum^{}_{s' \in S} \lambda p(s' | s, a) v(s') \right\}
\]

\begin{lemma}
    $ \forall v \in V, 0 \le \lambda < 1, \sup_{d \in D^{MD}} \left\{ r_d + \lambda P_d v \right\}
    = \sup_{d \in D^{MR}} \left\{ r_d + \lambda P_d v \right\}$ 
    \begin{proof}
        First, $ D^{MD} \subset D^{MR} $, so $ \sup_{d \in D^{MD}} \left\{ r_d + \lambda P_d v \right\}
    \preceq \sup_{d \in D^{MR}} \left\{ r_d + \lambda P_d v \right\} $.
    Second, $ \forall d^{MR} \in D^{MR} $,
    \[
        \sum^{}_{a \in A_s} q_{d^{MR}}(a) \left[ r(s, a) + \sum^{}_{s' \in S} \lambda p(s' | s, a) v(s') \right]
        \le \sup_{a \in A_s} \left\{ r(s, a) + \sum^{}_{s' \in S} \lambda p(s'|s, a) v(s') \right\}
    \]
    which means,
    \[
        r_{d^{MR}} +  \lambda P_{d^{MR}} v \preceq \sup_{d \in D^{MD}} \left\{ r_d + \lambda P_d v \right\}
        \Rightarrow \sup_{d \in D^{MR}}\left\{ r_d + \lambda P_d v \right\}
        \preceq \sup_{d \in D^{MD}}\left\{ r_d + \lambda P_d v \right\}
    \]
    
    \end{proof}
\end{lemma}

\begin{definition}
    (Bellman operator).
    \begin{equation}
        \forall v \in V, \mathcal{L} v = \sup_{d \in D^{MD}} \left\{ r_d + \lambda P_d v \right\}
    \end{equation}
    If the supremum is attained for all $ v \in V $, we define $ L $ by
    \begin{equation}
        \forall v \in V, Lv = \max_{d \in D^{MD}}\{r_d + \lambda P_d v\}
    \end{equation}
\end{definition}

\begin{theorem}
    Suppose there exists a $ v \in V $ for which
    \begin{enumerate}
        \item $ v \succeq \mathcal{L} v \Rightarrow v \succeq v^*_\lambda $;
        \item $ v \preceq \mathcal{L} v \Rightarrow v \preceq v^*_\lambda$;
        \item $ v = \mathcal{L} v \Rightarrow v $ is unique and $ v = v^*_\lambda $.
    \end{enumerate}
    \begin{proof}
        First, we proof 1.\\
        $ \forall \pi = (d_1, d_2, \ldots) \in \Pi^{MR} $,
        \begin{align*}
            v \succeq& \sup_{d \in D^{MD}} \left\{ r_d + \lambda P_d v \right\} = \sup_{d \in D^{MR}} \left\{ r_d + \lambda P_d v \right\} \\
            \succeq& r_{d_1} + \lambda P_{d_1} v = \sum^{n}_{t=1} {(\lambda P^\pi)}^{k-1} r_{d_t} + {(\lambda P^\pi)}^n v\\
            v - v^\pi_\lambda \succeq& {(\lambda P^\pi)}^n v - \sum^{\infty}_{t = n+1} {(\lambda P^\pi)}^{t-1} r_{d_t} \\
            \succeq& - \lambda^n \Arrowvert v \Arrowvert_{\infty} \cdot \vec e
            - \lambda^n \cdot \frac{M}{1-\lambda} \cdot \vec e
        \end{align*}
        Because $ r $ is bounded, so $ \forall \epsilon, \exists N $, when $ n \ge N $, we have
        \[
            v \succeq v^\pi_\lambda - \epsilon \cdot \vec e
        \]
        \[
            v \succeq \sup_{\pi \in \Pi^{MR}} v^\pi_\lambda = \sup_{\pi \in \Pi^{HR}} v^\pi_\lambda = v^*_\lambda
        \]
        Second, we proof 2.\\
        If $ v \preceq \mathcal{L} v $, by definition of $ \sup $, we have
        \[
            \forall \epsilon, \exists d \in D^{MD}, v \preceq r_d + \lambda P_d v + \epsilon \cdot \vec e 
        \]
        \[
            \Rightarrow v \preceq {(I - \lambda P_d)}^{-1}(r_d + \epsilon \cdot \vec e)
        = v^{d^\infty}_{\lambda} + {(1 - \lambda)}^{-1} \epsilon \cdot \vec e
    \preceq \sup_{\pi \in \Pi^{HR}} v^\pi_{\lambda} + {(1-\lambda)}^{-1} \epsilon \cdot \vec e
        \]
    \end{proof}
\end{theorem}

The following norm is supremum norm.
\begin{theorem}
    \textbf{(Banach Fixed-Point Theorem).} Suppose U is a Banach space and $ T: U \rightarrow U $ is a contraction mappintwith contraction parameter $ \lambda $.Then
    \begin{enumerate}
        \item there exists a unique $ v^* $ in U such that $ T v^* = v^* $;
            \item $ \forall v^0 \in U, \lim_{n \to \infty} v^n = \lim_{n \to \infty} T^n v^0 = v^* $.
    \end{enumerate}
    \begin{proof}
        \begin{align*}
            \forall m \ge 1,\quad \Arrowvert v^{n+m} - v^n \Arrowvert 
            \le& \sum^{m-1}_{k=0} \Arrowvert v^{n+k+1} - v^{n+k} \Arrowvert
            = \sum^{m-1}_{k=0} \Arrowvert T^{n+k} v^1 - T^{n+k} v^{0} \Arrowvert\\
            \le& \sum^{m-1}_{k=0} \lambda^{n+k} \Arrowvert v^1 - v^{0} \Arrowvert
            = \frac{\lambda^n (1-\lambda^m) }{(1-\lambda)} \Arrowvert v^1 - v^0 \Arrowvert
        \end{align*}
        It follows that $ \left\{ v^n \right\} $ is a Cauchy sequence.
        From the completeness of $ U $, it follows that $ \left\{ v^n \right\} $ has a limit $ v^\infty \in U $.
        \begin{align*}
            0 \le& \Arrowvert T v^\infty - v^\infty \Arrowvert 
            \le \Arrowvert T v^\infty - v^n \Arrowvert + \Arrowvert v^n - v^\infty \Arrowvert \\
            =& \Arrowvert Tv^\infty - Tv^{n-1} \Arrowvert + \Arrowvert v^n - v^\infty \Arrowvert
            \le \lambda \Arrowvert v^\infty - v^{n-1} \Arrowvert + \Arrowvert v^n - v^\infty \Arrowvert
            \rightarrow 0
        \end{align*}
        which means that $ v^\infty$ is a fixed point of T.
        Let $ u^* $ and $ v^* $ are fixed points of T, then
        \[
            \Arrowvert u^* - v^* \Arrowvert = \Arrowvert Tu^* - Tv^* \Arrowvert
            \le \lambda \Arrowvert u^* - v^* \Arrowvert
            \Rightarrow u^* = v^*
        \]
    \end{proof}
\end{theorem}

\begin{lemma}
    Suppose that $ 0 \le \lambda < 1 $; then $ L $ and $ \mathcal{L} $ are contraction mappings on V.
    \begin{proof}
        Let $ u, v \in V $,corresponding optimal actions are $ a_u, a_v $, fix $ s \in S $, without loss of generality, let $ Lu(s) \ge Lv(s) $.
        \begin{align*}
            0 \le& Lu(s) - Lv(s) = r(s, a_u) + \sum^{}_{s' \in S} \lambda p(s'|s, a_u) u(s') - Lv(s)\\
            \le& \sum^{}_{s' \in S} \lambda p(s'|s, a_u) (u(s') - v(s')) \le \lambda \Arrowvert u - v \Arrowvert_\infty\\
        \end{align*}
        $ \forall s \in S $, we have $ \left| Lu(s) - Lv(s) \right| \le \lambda \Arrowvert u - v \Arrowvert_\infty $ \\
        The proof of $ \mathcal{L} $ is analogue.
    \end{proof}
\end{lemma}

\begin{theorem}
    Suppose $ 0 \le \lambda < 1 $, $ S $ is finite or countable, and $ r(s,a) $ is bounded.
    If $ V $ is a complete normed linear space, there exists a unique $ v^* \in V $ satisfying $ Lv^*  = v^* $,
    and $ v^* = v^*_\lambda $.
\end{theorem}

\begin{definition}
    For $ v \in V $, call a decision rule $ d_v \in D^{MD} $ v-improving if
    \[
        d_v \in \arg\max_{d \in D^{MD}} \left\{ r_d + \lambda P_d v \right\} \Leftrightarrow L_{d_v} v = Lv
    \]
    Clarify:
    \begin{enumerate}
        \item $ v^{d^\infty_v}_\lambda $ needs not be greater than or equal to $ v $.
        \item Even if $ r_{d_v} + \lambda P_{d_v} v \succeq v $, $ v^{d^\infty_v}_\lambda $ exceeds  v in some component only if $ r_{d_v} (s') + \lambda P_{d_v} v(s') > v(s') $.
        \item $ d^* $, $ v^*_\lambda $-improving, is called conserving decision rule.
    \end{enumerate}
\end{definition}

\begin{theorem}
    If supremum is attained, then $ \exists d \in D^{MD}, d^\infty \in \Pi^{MD}$, satisfies $v^{d^\infty}_\lambda = v^*_\lambda $.
    So we can calculate that $ v^*_\lambda = \sup_{d \in D^{MD}} v^{d^\infty}_\lambda $.
    \begin{proof}
        \[
            v^*_\lambda = L v^*_\lambda = L_{d_{v^*_\lambda}}v^*_\lambda
            \Rightarrow v^*_\lambda = v^{d^\infty_{v^*_\lambda}}_\lambda
        \]
    \end{proof}
\end{theorem}

\begin{theorem}
    Assume S is discrete, and either
    \begin{enumerate}
        \item $ A_s $ is finite for each $ s \in S $, or
        \item $ A_s $ is compact, $ r(s,a) $ is continuous in a for each $ s \in S $, and for each $ s' \in S $ and $ s \in S $, $ p(s' | s, a) $ is continuous in a, or
        \item $ A_s $ is compact, $ r(s, a) $ is upper semicontinuous in $ a $ for each $ s \in S $, and for each $ s' \in S $ and $ s \in S $, $ p(s' | s, a) $ is lower semicontinuous in a.
    \end{enumerate}
    Then there exists an optimal deterministic stationary policy.
\end{theorem}

If the supremum is not attained in $ \mathcal{L}v $, then optimal policies need not exist.
\begin{theorem}
    Support S is finite or countable, then for all $ \epsilon > 0 $ there exists an $ \epsilon-optimal $deterministic stationary policy.
    \begin{proof}
        Take $ d_{\epsilon} $ satisfying
        \[
            r_{d_{\epsilon}} + \lambda P_{d_{\epsilon}} v^*_{\lambda} \succeq \sup _{d \in D^{MD}} \left\{ r_d + \lambda P_d v^*_{\lambda} \right\} - (1-\lambda)\epsilon \vec{1} = v^*_{\lambda} - (1-\lambda) \epsilon \vec{1}
        \]
        \[
            v^{d^{\infty}_{\epsilon}}_{\lambda} = {(I - \lambda P_{d_{\epsilon}})}^{-1}r_{d_{\epsilon}} \succeq v^*_{\lambda} - (1-\lambda)\epsilon{(I - \lambda P_{d_{\epsilon}})}^{-1} \vec{1} = v^*_{\lambda} - \epsilon \vec{1}
        \]
    \end{proof}
\end{theorem}

\subsection{VALUE ITERATION AND ITS VARIANTS}%
\label{sub:value_iteration_and_its_variants}

\subsubsection{Rates of Convergence}%

Rate of Convergence
\begin{enumerate}
    \item linear convergence or quadratic convergence: $ \Arrowvert y_{n+1} - y^* \Arrowvert \le K \Arrowvert y_n - y^* \Arrowvert^\alpha$;
    \item superlinearly convergence: $ \limsup_{n \rightarrow \infty} \frac{ \Arrowvert y_{n+1} - y^* \Arrowvert}{ \Arrowvert y_n - y^* \Arrowvert} = 0 $;
    \item asymptotic average rate of convergence $ \limsup_{n \rightarrow \infty} {\left[ \frac{\Arrowvert y_n - y^* \Arrowvert}{\Arrowvert y_0 - y^* \Arrowvert}  \right]}^{1/n} $
\end{enumerate}

\subsubsection{Value Iteration}%

\begin{algorithm}[h!]
    \caption{Value Iteration Algorithm}
    \begin{algorithmic}
        \Require{$ \epsilon > 0 $}
        \Ensure{$ v^0 \in V $}
        \For{$ n = 1, 2, \ldots $}
            \State{$\forall s \in S, v^{n+1}(s) = \max_{a \in A_s} \left\{ r(s,a) + \sum^{}_{s' \in S} \lambda p(s'|s, a) v^n(s') \right\} $}
            \If{$ \Arrowvert v^{n+1} - v^n \Arrowvert < \epsilon (1-\lambda) / (2\lambda)$}
                \State{break.}
            \EndIf.
        \EndFor.
        \State\Return{$ d_{\epsilon}(s) \in \arg\max_{a \in A_s} \left\{ r(s,a) + \sum^{}_{s' \in S} \lambda p(s' | s, a) v^{n+1}(s') \right\} $}
    \end{algorithmic}
\end{algorithm}
